#include <Wire.h>
#include <SPI.h>
#include <Adafruit_GFX.h>
#include <Adafruit_PCD8544.h>
Adafruit_PCD8544 lcd = Adafruit_PCD8544(7, 6, 5, 4, 3);

#define TEA5767_mute_left_right  0x06
#define TEA5767_MUTE_FULL        0x80
#define TEA5767_ADC_LEVEL_MASK   0xF0
#define TEA5767_STEREO_MASK      0x80

#define lcd_luminosity             8
#define button_back               10
#define button_frequency_down     11
#define button_frequency_up       12
#define button_menu               13

int frequency=10180;  //Frequenza iniziale

int old_frequency=-1;

byte old_stereo=0;
byte stereo=1;

byte old_mute=1;
byte mute=0;

byte old_signal_level=1;
byte signal_level=0;

int boot=0;

static const unsigned char PROGMEM boot1[] = {
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000111, B11100000, B00000000, B00000000, B11110000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00000000, B00000000, B00001001, B10011000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00000000, B00000000, B00011001, B10011000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00000111, B10001111, B00111101, B10011011, B01100000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00001000, B11011001, B10011001, B10011011, B10110000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000111, B11100011, B11011100, B00011001, B10011011, B00110000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00000110, B11001111, B00011001, B10011011, B00110000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00001100, B11000011, B10011001, B10011011, B00110000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00001100, B11011001, B10011001, B10011011, B00110000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000110, B00000111, B11001111, B00001100, B11110011, B00110000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00001111, B10000000, B00000000, B00000000, B10000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000010, B00000000, B00000000, B00000000, B10000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000010, B01110001, B11001111, B00011100, B10001110, B00111101, B00010000, B00000000, B00000000,
B00000000, B00000000, B00000010, B10001010, B00101000, B10100010, B10010001, B01000100, B10100000, B00000000, B00000000,
B00000000, B00000000, B00000010, B11111010, B00001000, B10100010, B10010001, B01000100, B10100000, B00000000, B00000000,
B00000000, B00000000, B00000010, B10000010, B00101000, B10100010, B10010001, B01000100, B10100000, B00000000, B00000000,
B00000000, B00000000, B00000010, B01111001, B11001000, B10011100, B10001110, B00111100, B01000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B01000100, B01000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00111001, B10000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000 };

static const unsigned char PROGMEM boot2[] = {

B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B10000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000110, B00011000, B00000000, B00000000, B00000000, B10000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000110, B00011000, B00000000, B00000010, B00000001, B10000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000110, B00101000, B00000000, B00000010, B00000001, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000110, B00111000, B11100001, B01100111, B00111001, B00011100, B00111000, B10110000, B01110000, B00000000,
B00000000, B00001110, B01010001, B00100001, B10100100, B01001001, B00100100, B01001000, B11010000, B10010000, B00000000,
B00000000, B00001011, B01010010, B00100001, B00100100, B00001001, B01100100, B10001000, B10010001, B10010000, B00000000,
B00000000, B00001001, B11010010, B00100001, B00100100, B01111001, B01111100, B10001000, B10010001, B11110000, B00000000,
B00000000, B00001001, B10010010, B00100010, B00100100, B10011011, B01000000, B10001001, B00010001, B00000000, B00000000,
B00000000, B00001001, B10010010, B01000010, B01100100, B10010010, B01001000, B10010001, B00110001, B00100000, B00000000,
B00000000, B00001001, B00110001, B11000010, B01000110, B11110010, B01110000, B01110001, B00100001, B11000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000111, B10000000, B00000000, B00100000, B00000000, B00000110, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000110, B01000000, B00000000, B00100000, B00000000, B01000110, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000110, B01000000, B00000000, B00100000, B00000000, B01000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000110, B01010100, B11100001, B10100100, B10001110, B11100100, B01110001, B01100000, B00000000, B00000000,
B00000000, B00000100, B01011001, B00100010, B01001100, B10001000, B10001100, B10010001, B10100000, B00000000, B00000000,
B00000000, B00001111, B10010010, B00100100, B01001000, B10010000, B10001001, B00010001, B00100000, B00000000, B00000000,
B00000000, B00001100, B00010010, B00100100, B01001001, B10010000, B10001001, B00010001, B00100000, B00000000, B00000000,
B00000000, B00001000, B00110010, B00100100, B11001001, B00010000, B10001001, B00010010, B00100000, B00000000, B00000000,
B00000000, B00001000, B00100010, B01000100, B11001001, B00010000, B10001001, B00100010, B01100000, B00000000, B00000000,
B00000000, B00001000, B00100001, B11000011, B11001111, B00011100, B11011000, B11100010, B01000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000 };

static const unsigned char PROGMEM boot3[] = {
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00111110, B00000000, B00000000, B01000001, B11000000, B00000000, B11110000, B00000000, B00100001, B00000000, B00000000,
B00100000, B00000000, B00000000, B01000010, B00100000, B00000000, B10001000, B00000000, B00100000, B00000000, B00000000,
B00100000, B00110000, B01111001, B11110010, B01100101, B10000000, B10001000, B11000001, B10100011, B00000111, B00000000,
B00111100, B00001000, B10000000, B01000010, B10100110, B01000000, B11110000, B00100010, B01100001, B00001000, B10000000,
B00100000, B00111000, B01110000, B01000011, B00100100, B01000000, B10100000, B11100010, B00100001, B00001000, B10000000,
B00100000, B01001000, B00001000, B01010010, B00100100, B01000000, B10010001, B00100010, B01100001, B00001000, B10000000,
B00100000, B00111100, B11110000, B00100001, B11000100, B01000000, B10001000, B11110001, B10100011, B10000111, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000001, B11111111, B11111000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00011110, B00001111, B11100010, B00000000, B00000100, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00100001, B00010000, B00010100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B01000000, B10100000, B00010100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B01000000, B11100000, B00011100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B01111111, B11111111, B11111100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B11111111, B11111111, B11111111, B11111111, B11111110, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B11111111, B11111111, B11111111, B11111111, B11111110, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B11111111, B11111111, B11111111, B11111111, B11111110, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B01111111, B11111111, B11111100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B01000000, B11100000, B00011100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B01000000, B10100000, B00010100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00100001, B00010000, B00010100, B00000000, B00000010, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00011110, B00001111, B11100010, B00000000, B00000100, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000001, B11111111, B11111000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00001111, B00000000, B00000000, B00000000, B00000000, B00001000, B00001000, B00000000, B00000000, B00000000,
B00000000, B00001000, B10000000, B00000000, B00000000, B00000000, B00001000, B00001000, B00000000, B00000000, B00000000,
B00000000, B00001000, B10011100, B10001001, B11001011, B00011100, B01101000, B00001011, B00100010, B00000000, B00000000,
B00000000, B00001111, B00100010, B10001010, B00101100, B10100010, B10011000, B00001100, B10100010, B00000000, B00000000,
B00000000, B00001000, B00100010, B10101011, B11101000, B00111110, B10001000, B00001000, B10011110, B00000000, B00000000,
B00000000, B00001000, B00100010, B10101010, B00001000, B00100000, B10011000, B00001100, B10000010, B00000000, B00000000,
B00000000, B00001000, B00011100, B01010001, B11001000, B00011100, B01101000, B00001011, B00100010, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00011100, B00000000, B00000000,
B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
B00000000, B00000000, B00000000, B10000111, B10001111, B00010001, B00111001, B00010001, B11000000, B00000000, B00000000,
B00000000, B00000000, B00000001, B01000100, B01001000, B10010001, B00010001, B00010010, B00100000, B00000000, B00000000,
B00000000, B00000000, B00000010, B00100100, B01001000, B10010001, B00010001, B10010010, B00100000, B00000000, B00000000,
B00000000, B00000000, B00000010, B00100111, B10001000, B10010001, B00010001, B01010010, B00100000, B00000000, B00000000,
B00000000, B00000000, B00000011, B11100101, B00001000, B10010001, B00010001, B00110010, B00100000, B00000000, B00000000,
B00000000, B00000000, B00000010, B00100100, B10001000, B10010001, B00010001, B00010010, B00100000, B00000000, B00000000,
B00000000, B00000000, B00000010, B00100100, B01001111, B00001110, B00111001, B00010001, B11000000, B00000000, B00000000 
};

static const unsigned char PROGMEM menu[] = {
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B11110111, B11011111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B11110011, B10011000, B11100010, B11011111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B11110011, B01010111, B01101010, B11011111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B11110101, B01010000, B01101010, B11011111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B11110101, B01010111, B11101010, B11011111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B11110110, B11011000, B11101010, B00011111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B10100000, B00000000, B00001000, B00000000, B00000010, B00000110, B00000000, B00000000, B00100001, B11000000, B00010000,
B10100000, B00000000, B00000000, B00000000, B00000000, B01000000, B00000000, B00000000, B00100010, B00100000, B00010000,
B10100001, B00101111, B11101011, B11001110, B01111010, B11101110, B00000000, B00000000, B00100010, B00101110, B00010000,
B10100001, B00101001, B00101010, B01010001, B01000010, B01000001, B00000000, B00000000, B00100010, B00101001, B00010000,
B10100001, B00101001, B00101010, B01010001, B00110010, B01000111, B00000000, B00000000, B00100010, B00101001, B00010000,
B10100001, B00101001, B00101010, B01010001, B01001010, B01001001, B00000000, B00000000, B00100010, B00101001, B00010000,
B10111101, B11101001, B00101010, B01001110, B00111010, B01100111, B00000000, B00000000, B00100001, B11001001, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B10011100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100000, B11100110, B00010000,
B10100010, B00000000, B00100000, B00000000, B00001000, B00000000, B00000000, B00000000, B00100000, B10001001, B00010000,
B10100000, B01100111, B01110111, B01111001, B11011100, B11000000, B00000000, B00000000, B00100001, B11001001, B00010000,
B10100000, B10010100, B10100100, B00001010, B00001001, B00100000, B00000000, B00000000, B00100001, B00101001, B00010000,
B10100000, B10010100, B10100100, B00111001, B10001001, B00100000, B00000000, B00000000, B00100000, B00101001, B00010000,
B10100010, B10010100, B10100100, B01001000, B01001001, B00100000, B00000000, B00000000, B00100001, B00101001, B00010000,
B10011100, B01100100, B10110100, B01111011, B10001100, B11000000, B00000000, B00000000, B00100000, B11001110, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100000, B11100110, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100000, B10001001, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100001, B11001001, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100001, B00101001, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100000, B00101001, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100001, B00101001, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00100000, B11001110, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00010000,
B10111111, B11111111, B11111011, B11111111, B11111111, B10011111, B11111111, B11111101, B11111111, B11111111, B11010000,
B10111111, B01111111, B11111011, B11111111, B10111111, B10011111, B11101111, B11111101, B11111000, B11010111, B11010000,
B10111110, B01111111, B11111011, B11111110, B00111111, B10011111, B11100011, B11111101, B11110111, B01010111, B11010000,
B10111100, B00000000, B01111011, B11111000, B00111111, B10011111, B11100000, B11111101, B11110111, B01001111, B11010000,
B10111110, B01111111, B01111011, B11111110, B00111111, B10011111, B11100011, B11111101, B11110111, B01010111, B11010000,
B10111111, B01111000, B01111011, B11111111, B10111111, B10011111, B11101111, B11111101, B11111000, B11011011, B11010000,
B10111111, B11111111, B11111011, B11111111, B11111111, B10011111, B11111111, B11111101, B11111111, B11111111, B11010000,
B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11110000 };

unsigned long last_pressed;
void setup(void) {

  pinMode(button_back, INPUT);
  pinMode(button_frequency_down, INPUT);
  pinMode(button_frequency_up, INPUT);
  pinMode(button_menu, INPUT);
  pinMode(lcd_luminosity, OUTPUT);
  digitalWrite(lcd_luminosity,HIGH);
  Wire.begin();

  TEA5767_mute();
  TEA5767_set_frequency();

  lcd.begin();
  lcd.setContrast(50);
  
   if(boot==0){bootanimation();}
  set_text(1,2,"FM Radio",BLACK,1);
  TEA5767_mute();
  }

void bootanimation(){
  lcd.clearDisplay();  
  lcd.drawBitmap(0, 0,  boot1, 84, 48, 1);
  lcd.display();
  delay(1250);
  lcd.clearDisplay();  
  lcd.drawBitmap(0, 0,  boot2, 84, 48, 1);
  lcd.display();
  delay(1250);
  lcd.clearDisplay();  
  lcd.drawBitmap(0, 0,  boot3, 84, 48, 1);
  lcd.display();
  delay(2000);
  lcd.clearDisplay();
  boot=1;
}
void loop() {
  
    if(frequency!=old_frequency){
      set_text(old_frequency>=10000?6:14,17,value_to_string(old_frequency),WHITE,2);
      set_text(frequency>=10000?6:14,17,value_to_string(frequency),BLACK,2);
      old_frequency=frequency;
    }
    
    TEA5767_read_data();
      
    if(old_stereo!=stereo){ 
        set_text(old_stereo?22:28,39,old_stereo?"Stereo":"Mono",WHITE,1);
        set_text(stereo?22:28,39,stereo?"Stereo":"Mono",BLACK,1);
        old_stereo=stereo;
    }
    
    if(old_signal_level!=signal_level){
        set_text(old_signal_level<10?76:70,39,String((int)old_signal_level),WHITE,1);
        set_text(signal_level<10?76:70,39,String((int)signal_level),BLACK,1);
        old_signal_level=signal_level;
        show_signal_level(signal_level);
    }
    
    if(old_mute!=mute){
        set_text(1,39,old_mute?"M":"S",WHITE,1);
        set_text(1,39,mute?"M":"S",BLACK,1);
        old_mute=mute;
    }
      
    delay(50);
    
  if(digitalRead(button_frequency_down)==HIGH){
    frequency=frequency-2.8;
    if(frequency<8750)frequency=10800;
    TEA5767_set_frequency();
  }

  else if(digitalRead(button_frequency_up)==HIGH){
    frequency=frequency+2.8;
    if(frequency>10800)frequency=8750;
    TEA5767_set_frequency();
  }
  
  else if(digitalRead(button_menu)==HIGH){
    digitalWrite(lcd_luminosity,LOW);

    lcd.clearDisplay();  
    lcd.drawBitmap(0, 0,  menu, 84, 48, 1);
    lcd.display();
    if(digitalRead(button_back)==HIGH){
    lcd.clearDisplay();
  TEA5767_set_frequency();

  lcd.begin();
  lcd.setContrast(50);
  
   if(boot==0){bootanimation();}
  set_text(1,2,"FM Radio",BLACK,1);


  }
  }
 
  delay(50);
  
}

unsigned char frequencyH = 0;
unsigned char frequencyL = 0;

unsigned int frequencyB;

unsigned char TEA5767_buffer[5]={0x00,0x00,0xB0,0x10,0x00};

void TEA5767_write_data(byte data_size){
   
  delay(50);
  Wire.beginTransmission(0x60);
  
  for(byte i=0;i<data_size;i++)
  Wire.write(TEA5767_buffer[i]);
  Wire.endTransmission();
  delay(50);
}

void TEA5767_mute(){ 
  
  if(!mute){   
    mute = 1;   
    TEA5767_buffer[0] |= TEA5767_MUTE_FULL;
    TEA5767_write_data(2);
  }   
  else{
    mute = 0;   
    TEA5767_buffer[0] &= ~TEA5767_MUTE_FULL;
    TEA5767_write_data(2);

  }
    
}

void TEA5767_set_frequency()
{
  frequencyB = 4 * (frequency * 10000 + 225000) / 32768;
  TEA5767_buffer[0] = frequencyB >> 8;
  if(mute)TEA5767_buffer[0] |= TEA5767_MUTE_FULL;
  TEA5767_buffer[1] = frequencyB & 0XFF;
  
  TEA5767_write_data(5);
}

int TEA5767_read_data() {
  
  unsigned char buf[5];
  memset (buf, 0, 5);
  
  Wire.requestFrom (0x60, 5); 

  if (Wire.available ()) {
    for (int i = 0; i < 5; i++) {
      buf[i] = Wire.read ();
    }
        
    stereo = (buf[2] & TEA5767_STEREO_MASK)?1:0;
    signal_level = ((buf[3] & TEA5767_ADC_LEVEL_MASK) >> 4);
    
    return 1;
  } 
  else return 0;
}

void show_signal_level(int level){
  
  byte xs=68;
  byte ys=8;
  for(int i=0;i<15;i++){
    if(i%2!=0)lcd.drawLine(xs+i,ys,xs+i,ys-i/2,level>=i?BLACK:WHITE);
  }
}

void set_text(int x,int y,String text,int color,int textsize){
  
  lcd.setTextSize(textsize);
  lcd.setTextColor(color); 
  lcd.setCursor(x,y);     
  lcd.println(text);      
  lcd.display();         
}


String value_to_string(int value){
  
  String value_string = String(value / 100);
  value_string = value_string + '.' + ((value%100<10)?"0":"") + (value % 100);
  return value_string;
}

